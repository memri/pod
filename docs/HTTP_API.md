# About
This documentation is part of [Pod](../README.md).

HTTP API is the interface that Pod provides to store and access user data.
This document explains the data types that Pod can store,
and current API provided for that.


# API Authentication & Credentials
Some endpoints require additional authentication / credentials.

In text below, `databaseKey` means a 64-character hex string to be used with sqlcipher.
It should be generated by the client once and kept there.
This key will never be written to disk by Pod, and is used to open the database.
You can read more on how this key is used in sqlcipher
[here](https://github.com/sqlcipher/sqlcipher).

In text below, `owner_key` means the full client's public [ED25519](https://ed25519.cr.yp.to/) key
(see also [wikipedia](https://en.wikipedia.org/wiki/Curve25519)).
It should be encoded as 64-character hex string.
Pods configured with "ANY" as their owner will accept requests from any `owner_key`,
but will still require a correct `databaseKey` to open the database.

⚠️ UNSTABLE: The use of this key for authentication will be changed in the nearest future.
Note that incorrect database key (below) will also fail any request.


# Schema API
Schema defines what types can be stored in Pod. You can read more
about the Schema itself [here](./Schema.md).

In order to make changes to the schema, insert items of a specific structure in the Pod.
The following properties are expected:
```json5
{
  "type": "ItemPropertySchema", /* exactly this, and nothing else */
  "itemType": "YourType", /* e.g. "Person" */
  "propertyName": "yourProperty", /* e.g. "age" */
  "valueType": "Integer", /* one of valid Schema types, see Schema docs*/
}
```

Note that you cannot both change the Schema and refer to the new Schema
in one `bulk` request, so if you want changes to the Schema to happen first,
split updates to the Schema into a separate request.
(This constraint might be lifted in the future.)


# Items API

### GET /version
Get version of the Pod: the git commit and cargo version that it was built from.


### POST /v3/$owner_key/get_item
```json
{
  "databaseKey": "2DD29CA851E7B56E4697B0E1F08507293D761A05CE4D1B628663F411A8086D99",
  "payload": $id
}
```
Get a single item by its `id`.

Returns an empty array if an item is not found,
or an array with 1 item if item exists.


### POST /v3/$owner_key/create_item
```json
{
  "databaseKey": "2DD29CA851E7B56E4697B0E1F08507293D761A05CE4D1B628663F411A8086D99",
  "payload": { "type": "...", ... }
}
```
Create a single item.

* `id` if set, will be taken as new item's `id`;
    otherwise, a new id will be generated by Pod
* `type` sets the type of the item, cannot ever be changed
* `dateCreated` if not present, will be set by the backend
* `dateModified` if not present, will be set by the backend
* `dateServerModified` will be created by the backend
* any other properties will be added to the item's properties

Returns an error if such `id` already exist in the DB.
Returns an error if the new item doesn't conform to the Schema.
Returns `id` of the created item if the operation is successful. 


### POST /v3/$owner_key/update_item
```json
{
  "databaseKey": "2DD29CA851E7B56E4697B0E1F08507293D761A05CE4D1B628663F411A8086D99",
  "payload": { "id": $id, ... }
}
```
Update a single item.

* `id` from the input json will be taken as the item's `id`
* `type` from the input json will be ignored
* `dateCreated` from the input json will be ignored
* `dateModified` if not present, will be updated by the backend
* `dateServerModified` will be created by the backend
* properties with a value of `null` will be erased from the item
* any other properties will be updated

Returns an empty object if the operation is successful.


### POST /v3/$owner_key/delete_item
```json
{
  "databaseKey": "2DD29CA851E7B56E4697B0E1F08507293D761A05CE4D1B628663F411A8086D99",
  "payload": $id
}
```
Mark an item as deleted:
* Set `deleted` flag to `true`
* Update `dateModified` (server's time is taken)
* Update `dateServerModified`


### POST /v3/$owner_key/search
```json
{
  "databaseKey": "2DD29CA851E7B56E4697B0E1F08507293D761A05CE4D1B628663F411A8086D99",
  "payload": {
    "type": "Label",
    "dateServerModified>=": 1234567890,
    "dateServerModified<": 1234567890,
    "deleted": false
  }
}
```
Search items by their properties.

The endpoint will return an array of all items with exactly the same properties.

As a first step of the 2021-03 Pod rewrite, only the above properties are supported.
In the future, any will be available.


### POST /v3/$owner_key/bulk
```json
{
  "databaseKey": "2DD29CA851E7B56E4697B0E1F08507293D761A05CE4D1B628663F411A8086D99",
  "payload": {
    "createItems": [
      { "id": "something-12345", "type": "Person", ... }, ...
    ],
    "updateItems": [
      { "id": "something-67899", ... }, ...
    ],
    "deleteItems": [ $id, $id, $id, ...],
  }
}
```
Perform a bulk of operations in one request.
The endpoint is "atomic", meaning that either all the operations succeed,
or the database won't be changed at all.

Returns an empty object if the operation is successful.


<!--
# Services API
Services help getting data into your Pod and enriching it.
Services can only be ever run / authorized to run by the user.
Typical examples of services are services that import emails/messages into Pod.

### POST /v3/$owner_key/run_importer
```json
{
  "databaseKey": "2DD29CA851E7B56E4697B0E1F08507293D761A05CE4D1B628663F411A8086D99",
  "payload": {
    "id": $id,
    "servicePayload": {
      "databaseKey": "2DD29CA851E7B56E4697B0E1F08507293D761A05CE4D1B628663F411A8086D99",
      "ownerKey": $owner_key
    }
  }
}
```
Run an importer on an item with the given id.
See [Integrators](./Integrators.md).


# File API


### POST /v3/$owner_key/upload_file/$database_key/$sha256hashOfTheFile
```text
RAW-FILE-BINARY
```
Upload a file into Pod and verify it's `sha256`.
`owner_key`, database key and sha256 are all hex-encoded.

If a file with a given `sha256` has already being uploaded, the request will fail.
If the provided `sha256` doesn't match the hash of the contents, the request will fail.
If no item with this `sha256` exists in the database, Pod wouldn't be able to store
cryptographic information about the file, and the request will also fail.

If `sha256` matches, the file has not yet been uploaded to Pod and if an item
with such `sha256` already exists in DB, Pod will accept the file and store it.
The properties `nonce` and `key` will be updated for this item.


### POST /v3/$owner_key/get_file
```json
{
  "databaseKey": "2DD29CA851E7B56E4697B0E1F08507293D761A05CE4D1B628663F411A8086D99",
  "payload": {
    "sha256": $sha256
  }
}
```
Get a file by its sha256 hash.
If the file does not yet exist in Pod, a 404 NOT FOUND error will be returned.
-->
